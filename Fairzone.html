<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>معرض مغامرة الابطال</title>
<link rel="icon" type="image/png" href="https://i.ibb.co/FbfJxWvn/logo.png">
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: "Cairo", sans-serif;
    direction: rtl;
    background: url("https://i.ibb.co/FbfJxWvn/logo.png") no-repeat center center fixed;
    background-size: cover;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }
  .container {
    background: rgba(255, 255, 255, 0.95);
    padding: 25px;
    border-radius: 15px;
    max-width: 420px;
    width: 90%;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  h2 { margin: 0 0 10px; font-size: 24px; color: #333; }
  input, button, .class-box {
    width: 100%;
    padding: 14px;
    margin: 10px 0;
    border: none;
    border-radius: 8px;
    font-size: 18px;
  }
  input { border: 1px solid #ccc; }
  button { background: #007BFF; color: #fff; font-weight: bold; cursor: pointer; }
  button:hover { background: #0056b3; }
  .class-box { background: #f0f0f0; cursor: pointer; font-weight: bold; }
  .class-box:hover { background: #ddd; }
  .suggestions { background: #fff; border: 1px solid #ccc; border-radius: 8px; max-height: 150px; overflow-y: auto; }
  .suggestions div { padding: 10px; cursor: pointer; }
  .suggestions div:hover { background: #eee; }
  .results { margin-top: 20px; display: flex; flex-direction: column; gap: 14px; }
  .result-row { display: flex; justify-content: space-between; align-items: center; }
  .label { flex: 1; text-align: right; font-weight: bold; color: #fff; margin-left: 10px; padding: 10px; border-radius: 8px; }
  .result-item { flex: 1.5; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: #fff; border-radius: 8px; min-height: 50px; }
  .blue { background: #4da6ff; } .red { background: #ff4d4d; } .green { background: #28a745; }
  @media (max-width: 768px) and (orientation: portrait) {
    h2 { font-size: 26px; }
    input, button, .class-box { font-size: 20px; padding: 16px; }
    .label, .result-item { font-size: 20px; min-height: 60px; }
  }
</style>
</head>
<body>
<div class="container" id="app">
  <h2>مغامرة الأبطال</h2>

  <!-- صفحة تسجيل الدخول -->
  <div id="loginPage">
    <input type="text" id="username" placeholder="اسم المستخدم">
    <input type="password" id="password" placeholder="كلمة المرور">
    <button onclick="login()">دخول</button>
  </div>

  <!-- اختيار نوع الأدمن -->
  <div id="adminChoice" style="display:none;">
    <h2>اختيار الوضع</h2>
    <button onclick="enterView()">👀 عرض النتائج</button>
    <button onclick="enterEdit()">✏ تعديل النتائج</button>
  </div>

  <!-- اختيار الفرقة -->
  <div id="classPage" style="display:none;">
    <h2>اختر الفرقة</h2>
    <div class="class-box" onclick="selectClass('1ب')">1ب</div>
    <div class="class-box" onclick="selectClass('2ب')">2ب</div>
    <div class="class-box" onclick="selectClass('3ب')">3ب</div>
    <div class="class-box" onclick="selectClass('4ب')">4ب</div>
    <div class="class-box" onclick="selectClass('5ب')">5ب</div>
    <div class="class-box" onclick="selectClass('6ب')">6ب</div>
  </div>

  <!-- البحث -->
  <div id="searchPage" style="display:none;">
    <h2>البحث عن الطالب</h2>
    <input type="text" id="nameInput" placeholder="ادخل الاسم">
    <div id="suggestions" class="suggestions"></div>
    <button onclick="search()">بحث</button>
    <div class="results">
      <div class="result-row"><span class="label blue">الحضور + الواجب</span><div id="B" class="result-item blue">—</div></div>
      <div class="result-row"><span class="label blue">التفاعل + الهدوء</span><div id="D" class="result-item blue">—</div></div>
      <div class="result-row"><span class="label red">الـ Minus</span><div id="E" class="result-item red">—</div></div>
      <div class="result-row"><span class="label green">المجموع</span><div id="F" class="result-item green">—</div></div>
    </div>
    <button id="markAttendanceBtn" onclick="markExhibition()">✅ تم حضور المعرض</button>
    <button id="backBtn" onclick="goBack()">⬅️ رجوع</button>
  </div>

  <!-- صفحة التعديل -->
  <div id="editPage" style="display:none;">
    <h2>تعديل البيانات</h2>
    <input type="text" id="editName" placeholder="ادخل الاسم">
    <div id="editSuggestions" class="suggestions"></div>
    <div style="text-align:right;">
      <label><input type="radio" name="field" value="interaction"> تعديل التفاعل + الهدوء</label><br>
      <label><input type="radio" name="field" value="minus"> تعديل الـ Minus</label>
    </div>
    <input type="number" id="newValue" placeholder="القيمة الجديدة">
    <button onclick="editData()">تعديل</button>
    <button id="markAttendanceBtn" onclick="markExhibition()">✅ تم حضور المعرض</button>
    <button id="backBtn" onclick="goBack()">⬅️ رجوع</button>
  </div>
</div>

<script>
const API_URL = "https://fairzone.johnmamdouh777.workers.dev/"; 
let allNames = [];
let selectedSheet = "";
let mode = "view";

// تسجيل الدخول
function login() {
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();

  // قائمة الأدمنز
  const admins = [
    { username: "besho", password: "123" },
    { username: "john", password: "viscabarca" }
  ];

  // قائمة المستخدمين العاديين
  const users = [
    { username: "hgf", password: "2182013" },
    { username: "user", password: "123" },
  ];

  // التحقق من الأدمن
  const isAdmin = admins.find(a => a.username === u && a.password === p);
  if (isAdmin) {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("adminChoice").style.display = "block";
    return;
  }

  // التحقق من المستخدم
  const isUser = users.find(a => a.username === u && a.password === p);
  if (isUser) {
    mode = "view";
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("classPage").style.display = "block";
    return;
  }

  // لو لا أدمن ولا يوزر
  alert("❌ اسم المستخدم أو كلمة المرور غير صحيحة");
}

// اختيار وضع الأدمن
function enterView() {
  mode = "view";
  document.getElementById("adminChoice").style.display = "none";
  document.getElementById("classPage").style.display = "block";
}
function enterEdit() {
  mode = "edit";
  document.getElementById("adminChoice").style.display = "none";
  document.getElementById("classPage").style.display = "block";
}

// اختيار الفرقة
function selectClass(sheet) {
  selectedSheet = sheet;
  document.getElementById("classPage").style.display = "none";
  if (mode === "view") {
    document.getElementById("searchPage").style.display = "block";
    loadNames("getNames"); // من الشيت القديم
  } else {
    document.getElementById("editPage").style.display = "block";
    loadNames("getEditNames"); // من الشيت الجديد
  }
}

// تحميل الأسماء
function loadNames(action) {
  fetch(`${API_URL}?action=${action}&sheet=${encodeURIComponent(selectedSheet)}`)
    .then(res => res.json())
    .then(data => allNames = data.names || [])
    .catch(err => { console.error("Error loading names:", err); allNames = []; });
}

// اقتراحات
function showSuggestions(value, target, inputId) {
  const suggestions = document.getElementById(target);
  suggestions.innerHTML = "";
  if (!value || allNames.length === 0) return;
  allNames.filter(n => n.toLowerCase().includes(value.toLowerCase())).slice(0,5).forEach(n => {
    const div = document.createElement("div");
    div.textContent = n;
    div.onclick = () => { document.getElementById(inputId).value = n; suggestions.innerHTML = ""; };
    suggestions.appendChild(div);
  });
}
document.getElementById("nameInput").addEventListener("input", e => showSuggestions(e.target.value,"suggestions","nameInput"));
document.getElementById("editName").addEventListener("input", e => showSuggestions(e.target.value,"editSuggestions","editName"));

// البحث
function search() {
  const name = document.getElementById("nameInput").value;
  if (!allNames.includes(name)) { alert("❌ اختر الاسم من الاقتراحات"); return; }
  fetch(`${API_URL}?action=getData&sheet=${encodeURIComponent(selectedSheet)}&name=${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("B").textContent = data.B || "—";
      document.getElementById("D").textContent = data.D || "—";
      document.getElementById("E").textContent = data.E || "—";
      document.getElementById("F").textContent = data.F || "—";
    });
}

// تعديل
// تعديل
function editData() {
  const name = document.getElementById("editName").value;
  const field = document.querySelector("input[name='field']:checked");
  const newValue = document.getElementById("newValue").value;

  if (!allNames.includes(name)) return alert("❌ اختر الاسم من الاقتراحات");
  if (!field) return alert("❌ اختر نوع التعديل");
  if (newValue === "") return alert("❌ أدخل القيمة الجديدة");

  fetch(`${API_URL}?action=updateData&sheet=${encodeURIComponent(selectedSheet)}&name=${encodeURIComponent(name)}&field=${field.value}&value=${encodeURIComponent(newValue)}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✅ تم التعديل بنجاح");
        // تصفير المربعات
        document.getElementById("editName").value = "";
        document.getElementById("newValue").value = "";
        document.getElementById("editSuggestions").innerHTML = "";
        document.querySelectorAll("input[name='field']").forEach(r => r.checked = false);
      } else {
        alert(data.error || "❌ حصل خطأ أثناء التعديل");
      }
    })
    .catch(err => console.error("Error editing:", err));
}

// رجوع
function goBack() {
  // 🟢 تصفير مربعات الإدخال
  const searchInput = document.getElementById("nameInput");
  const editInput = document.getElementById("editName");
  if (searchInput) searchInput.value = "";
  if (editInput) editInput.value = "";

  // 🟢 تصفير الاقتراحات
  const suggestions = document.getElementById("suggestions");
  const editSuggestions = document.getElementById("editSuggestions");
  if (suggestions) suggestions.innerHTML = "";
  if (editSuggestions) editSuggestions.innerHTML = "";

  // 🟢 تصفير نتائج البحث (B, D, E, F)
  const resultIds = ["B", "D", "E", "F"];
  resultIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = "—"; // يرجع الشرطة زي الأول
  });

  // 🔵 منطق التنقل زي ما هو
  if (document.getElementById("searchPage").style.display === "block" || document.getElementById("editPage").style.display === "block") {
    document.getElementById("searchPage").style.display = "none";
    document.getElementById("editPage").style.display = "none";
    document.getElementById("classPage").style.display = "block";
  } else if (document.getElementById("classPage").style.display === "block") {
    document.getElementById("classPage").style.display = "none";
    if (mode === "edit" || mode === "view") document.getElementById("adminChoice").style.display = "block";
    else document.getElementById("loginPage").style.display = "block";
  }
}

  function markExhibition() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) {
    alert("❌ الرجاء إدخال الاسم أولاً");
    return;
  }

  fetch(`${API_URL}?action=markExhibition&sheet=${selectedSheet}&name=${encodeURIComponent(name)}`)
    .then(res => res.text())
    .then(result => {
      if (result === "OK") {
        alert("✅ تم تسجيل حضور المعرض لهذا الطالب");

        // 🧹 تفريغ مربع الاسم
        document.getElementById("nameInput").value = "";

        // 🧹 تفريغ الاقتراحات
        document.getElementById("suggestions").innerHTML = "";

        // 🧹 تفريغ كل المربعات (خليها فاضية مش "—")
        ["B", "D", "E", "F"].forEach(id => {
          document.getElementById(id).textContent = "";
        });

      } else if (result === "NOT_FOUND") {
        alert("❌ الاسم غير موجود في الشيت");
      } else {
        alert("⚠ حصل خطأ: " + result);
      }
    })
    .catch(err => {
      console.error("Error:", err);
      alert("❌ حدث خطأ أثناء الاتصال بالخادم");
    });
}
  
</script>
</body>
</html>
